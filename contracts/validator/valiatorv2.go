// Copyright (c) 2024 XDPoSChain
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with this program. If not, see <http://www.gnu.org/licenses/>.

package validator

import (
	"sync"

	"github.com/XinFinOrg/XDPoSChain/common"
	"github.com/XinFinOrg/XDPoSChain/core/state"
	"github.com/XinFinOrg/XDPoSChain/log"
)

const (
	v1Hash = "0x43e5b04f4015a9345835af4980fea519f1a1f499cbfddd624696cca4dcd43657"
	v2Hash = "0x2bd18344988d402ba2d625aaccc1bdabdca4b8cd3a79526d1329f6dbae69abfb"

	v2Code = "0x6080604052600436106102035763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663012679518114610208578063025e7c271461021e57806302aa9be21461025257806306a49fce146102765780630999ec79146102db5780630db02622146102f05780630e3e4fb81461031757806315febd68146103525780631c68951c1461036a5780632a3640b11461040a5780632d15cc041461042e5780632f54bf6e1461044f5780632f9c4bba1461048b578063302b6872146104a057806332658652146104c75780633477ee2e1461055d5780634110a48914610575578063441a3e70146105be57806358e7525f146105d95780635b860d27146105fa5780635b9cd8cc1461061b5780635c134d661461063f57806367134e7014610663578063681d8bf2146106845780636dd7d8ea1461069957806372e44a38146106ad578063935ad0d1146106ce578063a9a981a3146106e3578063a9ff959e146106f8578063ae6e43f51461070d578063b622f1411461072e578063b642facd1461074f578063c45607df14610770578063d09f1ab414610791578063d161c767146107a6578063d51b9e93146107bb578063d55b7dff146107dc578063db11daef146107f1578063ef18374a14610812578063f2ee3c7d14610827578063f5c9512514610848578063f8ac9dd514610868575b600080fd5b61021c600160a060020a036004351661087d565b005b34801561022a57600080fd5b50610236600435610ced565b60408051600160a060020a039092168252519081900360200190f35b34801561025e57600080fd5b5061021c600160a060020a0360043516602435610d15565b34801561028257600080fd5b5061028b610fab565b60408051602080825283518183015283519192839290830191858101910280838360005b838110156102c75781810151838201526020016102af565b505050509050019250505060405180910390f35b3480156102e757600080fd5b5061021c61100e565b3480156102fc57600080fd5b506103056110f6565b60408051918252519081900360200190f35b34801561032357600080fd5b5061033e600160a060020a03600435811690602435166110fc565b604080519115158252519081900360200190f35b34801561035e57600080fd5b5061030560043561111c565b34801561037657600080fd5b5061038b600160a060020a036004351661113b565b6040518083815260200180602001828103825283818151815260200191508051906020019080838360005b838110156103ce5781810151838201526020016103b6565b50505050905090810190601f1680156103fb5780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b34801561041657600080fd5b50610236600160a060020a03600435166024356111e2565b34801561043a57600080fd5b5061028b600160a060020a0360043516611219565b34801561045b57600080fd5b50610470600160a060020a036004351661128f565b60408051921515835260208301919091528051918290030190f35b34801561049757600080fd5b5061028b6112f4565b3480156104ac57600080fd5b50610305600160a060020a0360043581169060243516611355565b3480156104d357600080fd5b506104e8600160a060020a0360043516611384565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561052257818101518382015260200161050a565b50505050905090810190601f16801561054f5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561056957600080fd5b506102366004356114ba565b34801561058157600080fd5b50610596600160a060020a03600435166114c8565b60408051600160a060020a039094168452911515602084015282820152519081900360600190f35b3480156105ca57600080fd5b5061021c600435602435611508565b3480156105e557600080fd5b50610305600160a060020a036004351661180c565b34801561060657600080fd5b50610305600160a060020a036004351661182b565b34801561062757600080fd5b506104e8600160a060020a0360043516602435611967565b34801561064b57600080fd5b50610236600160a060020a0360043516602435611a1d565b34801561066f57600080fd5b50610305600160a060020a0360043516611a38565b34801561069057600080fd5b5061021c611a53565b61021c600160a060020a0360043516611b35565b3480156106b957600080fd5b50610305600160a060020a0360043516611de7565b3480156106da57600080fd5b5061021c611df9565b3480156106ef57600080fd5b50610305612107565b34801561070457600080fd5b5061030561210d565b34801561071957600080fd5b5061021c600160a060020a0360043516612113565b34801561073a57600080fd5b5061033e600160a060020a0360043516612521565b34801561075b57600080fd5b50610236600160a060020a0360043516612536565b34801561077c57600080fd5b50610305600160a060020a0360043516612554565b34801561079d57600080fd5b5061030561256f565b3480156107b257600080fd5b50610305612575565b3480156107c757600080fd5b5061033e600160a060020a036004351661257b565b3480156107e857600080fd5b506103056125b1565b3480156107fd57600080fd5b5061033e600160a060020a03600435166125b7565b34801561081e57600080fd5b506103056125cc565b34801561083357600080fd5b5061021c600160a060020a03600435166125d2565b34801561085457600080fd5b5061021c6004803560248101910135612b18565b34801561087457600080fd5b50610305612c00565b600b546000903410156108df5760408051600080516020613118833981519152815260206004820152601560248201527f496e76616c69642043616e646964617465204361700000000000000000000000604482015290519081900360640190fd5b33600090815260036020526040902054151580610909575033600090815260066020526040812054115b15156109645760408051600080516020613118833981519152815260206004820152601060248201527f4b5943206e6f742075706c6f6164656400000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a038216600090815260116020526040902054829060ff16156109dc5760408051600080516020613118833981519152815260206004820152601160248201527f496e76616c69642043616e646964617465000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a03811660009081526001602052604090205474010000000000000000000000000000000000000000900460ff1615610a6a5760408051600080516020613118833981519152815260206004820152601360248201527f416c726561647920612063616e64696461746500000000000000000000000000604482015290519081900360640190fd5b600160a060020a03831660009081526001602081905260409091200154610a97903463ffffffff612c0616565b6008805460018181019092557ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee3018054600160a060020a0380881673ffffffffffffffffffffffffffffffffffffffff199283168117909355604080516060810182523380825260208281018881528385018a815260009889528983528589209451855492511515740100000000000000000000000000000000000000000274ff0000000000000000000000000000000000000000199190981692909816919091179690961694909417825593519581019590955591835260029093019092522054909250610b8c903463ffffffff612c0616565b600160a060020a038416600090815260016020818152604080842033855260020190915290912091909155600954610bc99163ffffffff612c0616565b600955336000908152600660205260409020541515610c3c5760078054600181810183556000929092527fa66cc928b5edb82af9bd49922954155ab7b0942694bea4ce44661d9a8736c68801805473ffffffffffffffffffffffffffffffffffffffff191633179055600a805490910190555b336000818152600660209081526040808320805460018181018355918552838520018054600160a060020a038a1673ffffffffffffffffffffffffffffffffffffffff1991821681179092558186526002855283862080549384018155865294849020909101805490941685179093558051938452908301919091523482820152517f7635f1d87b47fba9f2b09e56eb4be75cca030e0cb179c1602ac9261d39a8f5c19181900360600190a1505050565b6007805482908110610cfb57fe5b600091825260209091200154600160a060020a0316905081565b600160a060020a038216600090815260016020908152604080832033845260020190915281205483908390811115610d9c5760408051600080516020613118833981519152815260206004820152600c60248201527f496e76616c696420566f74650000000000000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a0382811660009081526001602052604090205416331415610e5357600b54600160a060020a0383166000908152600160209081526040808320338452600201909152902054610df8908363ffffffff612c1c16565b1015610e535760408051600080516020613118833981519152815260206004820181905260248201527f4d696e696d756d206361702073686f756c64206265206d61696e7461696e6564604482015290519081900360640190fd5b600160a060020a03851660009081526001602081905260409091200154610e80908563ffffffff612c1c16565b600160a060020a038616600090815260016020818152604080842092830194909455338352600290910190522054610ebe908563ffffffff612c1c16565b600160a060020a0386166000908152600160209081526040808320338452600201909152902055600f54610ef8904363ffffffff612c0616565b33600090815260208181526040808320848452909152902054909350610f24908563ffffffff612c0616565b33600081815260208181526040808320888452808352818420959095558282526001948501805495860181558352918190209093018690558051918252600160a060020a0388169282019290925280820186905290517faa0e554f781c3c3b2be110a0557f260f11af9a8aa2c64bc1e7a31dbb21e32fa29181900360600190a15050505050565b6060600880548060200260200160405190810160405280929190818152602001828054801561100357602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311610fe5575b505050505090505b90565b6060600080600880549050604051908082528060200260200182016040528015611042578160200160208202803883390190505b50925060009150600090505b6008548110156110de5760088054600091908390811061106a57fe5b600091825260209091200154600160a060020a0316146110d657600880548290811061109257fe5b6000918252602090912001548351600160a060020a03909116908490849081106110b857fe5b600160a060020a039092166020928302909101909101526001909101905b60010161104e565b8183526110f060086020850184612f16565b50505050565b600a5481565b600560209081526000928352604080842090915290825290205460ff1681565b336000908152602081815260408083208484529091529020545b919050565b6012602090815260009182526040918290208054600180830180548651600293821615610100026000190190911692909204601f8101869004860283018601909652858252919492939092908301828280156111d85780601f106111ad576101008083540402835291602001916111d8565b820191906000526020600020905b8154815290600101906020018083116111bb57829003601f168201915b5050505050905082565b6006602052816000526040600020818154811015156111fd57fe5b600091825260209091200154600160a060020a03169150829050565b600160a060020a03811660009081526002602090815260409182902080548351818402810184019094528084526060939283018282801561128357602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311611265575b50505050509050919050565b600080805b6007548110156112e65783600160a060020a03166007828154811015156112b757fe5b600091825260209091200154600160a060020a031614156112de57600181925092506112ee565b600101611294565b600092508291505b50915091565b336000908152602081815260409182902060010180548351818402810184019094528084526060939283018282801561100357602002820191906000526020600020905b815481526020019060010190808311611338575050505050905090565b600160a060020a0391821660009081526001602090815260408083209390941682526002909201909152205490565b606061138f8261257b565b1561149257600360006113a184612536565b600160a060020a0316600160a060020a031681526020019081526020016000206001600360006113d086612536565b600160a060020a0316815260208101919091526040016000205482549190039081106113f857fe5b600091825260209182902001805460408051601f60026000196101006001871615020190941693909304928301859004850281018501909152818152928301828280156114865780601f1061145b57610100808354040283529160200191611486565b820191906000526020600020905b81548152906001019060200180831161146957829003601f168201915b50505050509050611136565b600160a060020a0382166000908152600360205260409020805460001981019081106113f857fe5b6008805482908110610cfb57fe5b60016020819052600091825260409091208054910154600160a060020a0382169174010000000000000000000000000000000000000000900460ff169083565b336000908152601060205260408120548390839060ff16156115795760408051600080516020613118833981519152815260206004820152600d60248201527f496e76616c6964204f776e657200000000000000000000000000000000000000604482015290519081900360640190fd5b600082116115d65760408051600080516020613118833981519152815260206004820152601460248201527f496e76616c696420626c6f636b206e756d626572000000000000000000000000604482015290519081900360640190fd5b438211156116595760408051600080516020613118833981519152815260206004820152603560248201527f426c6f636b206e756d6265722073686f756c64206265206c657373207468616e60448201527f2063757272656e7420626c6f636b206e756d6265720000000000000000000000606482015290519081900360840190fd5b33600090815260208181526040808320858452909152812054116116cc5760408051600080516020613118833981519152815260206004820152601260248201527f4e6f2063617020746f2077697468647261770000000000000000000000000000604482015290519081900360640190fd5b3360009081526020819052604090206001018054839190839081106116ed57fe5b90600052602060002001541415156117545760408051600080516020613118833981519152815260206004820152600d60248201527f496e76616c696420696e64657800000000000000000000000000000000000000604482015290519081900360640190fd5b336000818152602081815260408083208984528083529083208054908490559383529190526001018054919450908590811061178c57fe5b60009182526020822001819055604051339185156108fc02918691818181858888f193505050501580156117c4573d6000803e3d6000fd5b50604080513381526020810187905280820185905290517ff279e6a1f5e320cca91135676d9cb6e44ca8a08c0b88342bcdb1144f6511b5689181900360600190a15050505050565b600160a060020a03166000908152600160208190526040909120015490565b600160a060020a038116600090815260116020526040812054829060ff16156118a35760408051600080516020613118833981519152815260206004820152601160248201527f496e76616c69642043616e646964617465000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a03811660009081526001602052604090205474010000000000000000000000000000000000000000900460ff1615156119325760408051600080516020613118833981519152815260206004820152601160248201527f496e76616c69642043616e646964617465000000000000000000000000000000604482015290519081900360640190fd5b61193a6125cc565b600160a060020a03841660009081526004602052604090205460640281151561195f57fe5b049392505050565b60036020528160005260406000208181548110151561198257fe5b600091825260209182902001805460408051601f60026000196101006001871615020190941693909304928301859004850281018501909152818152945090925090830182828015611a155780601f106119ea57610100808354040283529160200191611a15565b820191906000526020600020905b8154815290600101906020018083116119f857829003601f168201915b505050505081565b6002602052816000526040600020818154811015156111fd57fe5b600160a060020a031660009081526006602052604090205490565b6060600080600780549050604051908082528060200260200182016040528015611a87578160200160208202803883390190505b50925060009150600090505b600754811015611b2357600780546000919083908110611aaf57fe5b600091825260209091200154600160a060020a031614611b1b576007805482908110611ad757fe5b6000918252602090912001548351600160a060020a0390911690849084908110611afd57fe5b600160a060020a039092166020928302909101909101526001909101905b600101611a93565b8183526110f060076020850184612f16565b600c54341015611b945760408051600080516020613118833981519152815260206004820152601160248201527f496e76616c696420566f74657220436170000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a038116600090815260116020526040902054819060ff1615611c0c5760408051600080516020613118833981519152815260206004820152601160248201527f496e76616c69642043616e646964617465000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a03811660009081526001602052604090205474010000000000000000000000000000000000000000900460ff161515611c9b5760408051600080516020613118833981519152815260206004820152601160248201527f496e76616c69642043616e646964617465000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a03821660009081526001602081905260409091200154611cc8903463ffffffff612c0616565b600160a060020a0383166000908152600160208181526040808420928301949094553383526002909101905220541515611d4257600160a060020a038216600090815260026020908152604082208054600181018255908352912001805473ffffffffffffffffffffffffffffffffffffffff1916331790555b600160a060020a0382166000908152600160209081526040808320338452600201909152902054611d79903463ffffffff612c0616565b600160a060020a0383166000818152600160209081526040808320338085526002909101835292819020949094558351918252810191909152348183015290517f66a9138482c99e9baf08860110ef332cc0c23b4a199a53593d8db0fc8f96fbfc9181900360600190a15050565b60046020526000908152604090205481565b336000908152601060205260408120546060919060ff1615611e6a5760408051600080516020613118833981519152815260206004820152600d60248201527f496e76616c6964204f776e657200000000000000000000000000000000000000604482015290519081900360640190fd5b33600090815260126020908152604091829020600190810180548451600293821615610100026000190190911692909204601f810184900484028301840190945283825290929091830182828015611f035780601f10611ed857610100808354040283529160200191611f03565b820191906000526020600020905b815481529060010190602001808311611ee657829003601f168201915b505033600090815260126020526040812054855195975095509093119250611f7d9150505760408051600080516020613118833981519152815260206004820152600f60248201527f4e6f204b59432075706c6f616465640000000000000000000000000000000000604482015290519081900360640190fd5b6206978081014311611fde5760408051600080516020613118833981519152815260206004820152601460248201527f4b5943206e6f7420766572696669656420796574000000000000000000000000604482015290519081900360640190fd5b3360008181526012602081815260408084208481558151808401928390528581529590945291905291516120189260019092019190612f88565b503360009081526003602090815260408220805460018101808355918452928290208551919361204e9391019190860190612f88565b50507f949360d814b28a3b393a68909efe1fee120ee09cac30f360a0f80ab5415a611a33836040518083600160a060020a0316600160a060020a0316815260200180602001828103825283818151815260200191508051906020019080838360005b838110156120c85781810151838201526020016120b0565b50505050905090810190601f1680156120f55780820380516001836020036101000a031916815260200191505b50935050505060405180910390a15050565b60095481565b600f5481565b600160a060020a038082166000908152600160205260408120549091829182918291829187911633146121bb5760408051600080516020613118833981519152815260206004820152602160248201527f4f6e6c79206f776e65722063616e2063616c6c20746869732066756e6374696f60448201527f6e00000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b600160a060020a038716600090815260016020526040902054879074010000000000000000000000000000000000000000900460ff1615156122725760408051600080516020613118833981519152815260206004820152602560248201527f4f6e6c792063616e6469646174652063616e2063616c6c20746869732066756e60448201527f6374696f6e000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b600160a060020a0388166000908152600160208190526040909120805474ff0000000000000000000000000000000000000000191690556009546122bb9163ffffffff612c1c16565b6009556122c788612c2e565b3360009081526006602052604081208054909850965094505b858510156123d85787600160a060020a0316878681548110151561230057fe5b600091825260209091200154600160a060020a031614156123cd57866001870381548110151561232c57fe5b6000918252602090912001548754600160a060020a039091169088908790811061235257fe5b9060005260206000200160006101000a815481600160a060020a030219169083600160a060020a03160217905550866001870381548110151561239157fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff1916905586546123c7886000198301613002565b506123d8565b6001909401936122e0565b865415156123e9576123e933612d3c565b600160a060020a03881660008181526001602081815260408084203385526002810183529084205494909352819052015490945061242d908563ffffffff612c1c16565b600160a060020a0389166000908152600160208181526040808420928301949094553383526002909101905290812055600e54612470904363ffffffff612c0616565b3360009081526020818152604080832084845290915290205490935061249c908563ffffffff612c0616565b33600081815260208181526040808320888452808352818420959095558282526001948501805495860181558352918190209093018690558051918252600160a060020a038b169282019290925281517f4edf3e325d0063213a39f9085522994a1c44bea5f39e7d63ef61260a1e58c6d3929181900390910190a15050505050505050565b60116020526000908152604090205460ff1681565b600160a060020a039081166000908152600160205260409020541690565b600160a060020a031660009081526003602052604090205490565b600d5481565b600e5481565b600160a060020a031660009081526001602052604090205474010000000000000000000000000000000000000000900460ff1690565b600b5481565b60106020526000908152604090205460ff1681565b600a5490565b33600081815260116020526040812054909182918291829182916060918291849182919060ff16156126535760408051600080516020613118833981519152815260206004820152601160248201527f496e76616c69642043616e646964617465000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a03811660009081526001602052604090205474010000000000000000000000000000000000000000900460ff1615156126e25760408051600080516020613118833981519152815260206004820152601160248201527f496e76616c69642043616e646964617465000000000000000000000000000000604482015290519081900360640190fd5b6126eb33612536565b9950600560008b600160a060020a0316600160a060020a0316815260200190815260200160002060008c600160a060020a0316600160a060020a0316815260200190815260200160002060009054906101000a900460ff1615151561279f5760408051600080516020613118833981519152815260206004820152600d60248201527f416c726561647920766f74656400000000000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a03808b166000908152600560209081526040808320938f168352928152828220805460ff19166001908117909155600490915291902080549091019055604b6127ed6125cc565b600160a060020a038d1660009081526004602052604090205460640281151561281257fe5b0410612b0b57600160a060020a038b166000818152601060209081526040808320805460ff19166001908117909155601280845282852085815583518086019485905286815296909552909252925161287093929091019190612f88565b5061287a8b61128f565b985098508815612b0b57600854604080518281526020808402820101909152600098508897509080156128b7578160200160208202803883390190505b5060085460408051828152602080840282010190915291965080156128e6578160200160208202803883390190505b509350600092505b600854831015612a5857600880548490811061290657fe5b600091825260209091200154600160a060020a0390811692508b1661292a83612536565b600160a060020a03161415612a215760095461294d90600163ffffffff612c1c16565b600955845160018701968391879190811061296457fe5b600160a060020a0392831660209182029092018101919091528382166000908152601182526040808220805460ff1916600190811790915580845281832080547fffffffffffffffffffffff00000000000000000000000000000000000000000016815501829055928e16815260039091529081206129e291613026565b600160a060020a038b166000908152600660205260408120612a0391613047565b600160a060020a038b16600090815260046020526040812055612a4d565b8351600188019783918691908110612a3557fe5b600160a060020a039092166020928302909101909101525b6001909201916128ee565b8684528585528351612a71906008906020870190612f16565b50612a7b88612e4f565b7fe18d61a5bf4aa2ab40afc88aa9039d27ae17ff4ec1c65f5f414df6f02ce8b35e8b866040518083600160a060020a0316600160a060020a0316815260200180602001828103825283818151815260200191508051906020019060200280838360005b83811015612af6578181015183820152602001612ade565b50505050905001935050505060405180910390a15b5050505050505050505050565b3360009081526010602052604090205460ff1615612b855760408051600080516020613118833981519152815260206004820152600d60248201527f496e76616c6964204f776e657200000000000000000000000000000000000000604482015290519081900360640190fd5b604080519081016040528043815260200183838080601f01602080910402602001604051908101604052809392919081815260200183838082843750505092909352505033600090815260126020908152604090912083518155838201518051919350612bf9926001850192910190612f88565b5050505050565b600c5481565b600082820183811015612c1557fe5b9392505050565b600082821115612c2857fe5b50900390565b60085460005b81811015612d375782600160a060020a0316600882815481101515612c5557fe5b600091825260209091200154600160a060020a03161415612d2f57600880546000198401908110612c8257fe5b60009182526020909120015460088054600160a060020a039092169183908110612ca857fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055600880546000198401908110612cf057fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff191690556008805490612d29906000198301613002565b50612d37565b600101612c34565b505050565b60075460005b81811015612d375782600160a060020a0316600782815481101515612d6357fe5b600091825260209091200154600160a060020a03161415612e4757600780546000198401908110612d9057fe5b60009182526020909120015460078054600160a060020a039092169183908110612db657fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055600780546000198401908110612dfe57fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff191690556007805490612e37906000198301613002565b50600a8054600019019055612d37565b600101612d42565b600780546000198101919082908110612e6457fe5b60009182526020909120015460078054600160a060020a039092169184908110612e8a57fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03929092169190911790556007805482908110612ece57fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff191690556007805490612f07906000198301613002565b5050600a805460001901905550565b828054828255906000526020600020908101928215612f78579160200282015b82811115612f78578251825473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03909116178255602090920191600190910190612f36565b50612f84929150613065565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10612fc957805160ff1916838001178555612ff6565b82800160010185558215612ff6579182015b82811115612ff6578251825591602001919060010190612fdb565b50612f84929150613096565b815481835581811115612d3757600083815260209020612d37918101908301613096565b508054600082559060005260206000209081019061304491906130b0565b50565b50805460008255906000526020600020908101906130449190613096565b61100b91905b80821115612f8457805473ffffffffffffffffffffffffffffffffffffffff1916815560010161306b565b61100b91905b80821115612f84576000815560010161309c565b61100b91905b80821115612f845760006130ca82826130d3565b506001016130b6565b50805460018160011615610100020316600290046000825580601f106130f95750613044565b601f0160209004906000526020600020908101906130449190613096560008c379a000000000000000000000000000000000000000000000000000000000a165627a7a723058200de1221cb46c6b1a81a6ea20bc603d7444dfa2684c1dabd40cbb13c5c285acf20029"
)

var codeHash = ""
var once sync.Once

func Upgrade(statedb *state.StateDB) {
	if codeHash == "" {
		codeHash = statedb.GetCodeHash(common.MasternodeVotingSMCBinary).String()
	}

	if codeHash == v2Hash {
		// already V2
		log.Info("XDCValidator is already v2")
		return
	}

	if codeHash != v1Hash {
		// only upgrade from v1
		log.Info("XDCValidator is not v1")
		return
	}

	// upgrade from V1 to V2
	once.Do(func() {
		log.Info("XDCValidator", "current", v1Hash, "target", v2Hash)
		statedb.SetCode(common.MasternodeVotingSMCBinary, common.FromHex(v2Code))
		codeHash = statedb.GetCodeHash(common.MasternodeVotingSMCBinary).String()
		log.Info("XDCValidator", "current", codeHash)
	})
}
